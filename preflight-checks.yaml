# CouchCMS AI Toolkit - Pre-Flight Checks Configuration
# These checks run automatically before any code generation/modification
#
# Severity levels:
#   CRITICAL - Blocks code generation, must be fixed
#   ERROR - Blocks code generation, must be fixed
#   WARNING - Shows warning but allows continuation
#   INFO - Informs only, no blocking
#
# Schema per check:
#   pattern: string (regex) - Pattern to match in code
#   severity: string - One of: CRITICAL, ERROR, WARNING, INFO
#   message: string - Human-readable error message
#   fix: string - Suggested fix or fix description
#   auto_fix: boolean - Whether check can be auto-fixed
#   example: object (optional) - bad/good examples
#   reference: string (optional) - Documentation reference
#   ignore_in: array<string> (optional) - File patterns to ignore
#   threshold: number (optional) - Threshold for warnings
#
# Used by: Pre-flight check system before code generation

# =============================================================================
# COUCHCMS CHECKS
# =============================================================================
# CouchCMS-specific checks for template safety and correctness

couchcms:
  # HTML Comment Security - CouchCMS tags in comments are EXECUTED
  html_comment_security:
    pattern: "<!--[\\s\\S]*?<cms:[\\s\\S]*?-->"
    severity: CRITICAL
    message: "CouchCMS tags inside HTML comments are EXECUTED! This can cause crashes or unexpected behavior."
    fix: "Replace <cms: with [cms: inside HTML comments"
    auto_fix: true
    example:
      bad: "<!-- <cms:show title /> -->"
      good: "<!-- [cms:show title /] -->"

  # Nested embeds in capture - causes parse errors
  nested_embed_in_capture:
    pattern: "<cms:capture[^>]*>[\\s\\S]*?<cms:embed[^>]*>"
    severity: CRITICAL
    message: "Nested <cms:embed> inside <cms:capture> causes template parse errors."
    fix: "Use inline markup instead of <cms:embed> within captures"
    auto_fix: false
    reference: "framework/04-retro.md - CouchCMS capture limitations"

  # Paired else/else_if tags - must be self-closing
  paired_else_tags:
    pattern: "<cms:else\\s*>\\s*</cms:else>|<cms:else_if[^/]*>\\s*</cms:else_if>"
    severity: ERROR
    message: "<cms:else> and <cms:else_if> must be self-closing tags"
    fix: "Use <cms:else /> instead of <cms:else></cms:else>"
    auto_fix: true
    example:
      bad: "<cms:else></cms:else>"
      good: "<cms:else />"

  # Missing template extends
  missing_extends:
    pattern: "^<\\?php\\s+require_once.*cms\\.php.*\\?>\\s*(?!<cms:extends)"
    severity: WARNING
    message: "Template may be missing <cms:extends> for proper layout inheritance"
    fix: "Add <cms:extends 'layouts/base.html' /> after require_once"
    auto_fix: false

  # Missing invoke at end
  missing_invoke:
    pattern: "<\\?php\\s+require_once.*cms\\.php[\\s\\S]*(?!COUCH::invoke)"
    severity: WARNING
    message: "Template may be missing COUCH::invoke() at the end"
    fix: "Add <?php COUCH::invoke(); ?> at the end of the template"
    auto_fix: false

  # K_IGNORE_CONTEXT missing for routable templates
  routable_missing_ignore_context:
    pattern: "routable=['\"]1['\"][\\s\\S]*COUCH::invoke\\(\\s*\\)"
    severity: WARNING
    message: "Routable template should use COUCH::invoke(K_IGNORE_CONTEXT)"
    fix: "Change COUCH::invoke() to COUCH::invoke(K_IGNORE_CONTEXT)"
    auto_fix: true

# =============================================================================
# TYPESCRIPT CHECKS
# =============================================================================
# TypeScript code quality and type safety checks

typescript:
  # Avoid 'any' type
  any_type:
    pattern: ":\\s*any\\b"
    severity: WARNING
    message: "Avoid 'any' type - it defeats TypeScript's type safety"
    fix: "Define a specific type or interface"
    auto_fix: false

  # Console.log in production code
  console_log:
    pattern: "console\\.(log|debug|info)\\("
    severity: INFO
    message: "console.log detected - consider removing for production"
    fix: "Remove console.log or use a proper logging utility"
    auto_fix: false
    ignore_in:
      - "*.test.ts"
      - "*.spec.ts"
      - "scripts/*.ts"

  # Missing return type
  missing_return_type:
    pattern: "(function|const)\\s+\\w+\\s*=?\\s*\\([^)]*\\)\\s*(?!:)[^{]*{"
    severity: INFO
    message: "Function missing explicit return type annotation"
    fix: "Add return type: function name(): ReturnType { }"
    auto_fix: false

  # Non-null assertion overuse
  non_null_assertion:
    pattern: "\\w+!\\."
    severity: WARNING
    message: "Non-null assertion (!) can hide runtime errors"
    fix: "Use proper null checking or optional chaining"
    auto_fix: false

# =============================================================================
# SECURITY CHECKS
# =============================================================================
# Security vulnerability detection patterns

security:
  # XSS via innerHTML
  xss_innerhtml:
    pattern: "\\.innerHTML\\s*=(?!.*sanitize|.*escape)"
    severity: CRITICAL
    message: "Potential XSS vulnerability - innerHTML with unsanitized content"
    fix: "Use textContent for plain text, or escape/sanitize HTML content"
    auto_fix: false

  # eval() usage
  eval_usage:
    pattern: "\\beval\\s*\\("
    severity: CRITICAL
    message: "eval() is a security risk and should be avoided"
    fix: "Use alternative approach - JSON.parse() for JSON, Function constructor if absolutely needed"
    auto_fix: false

  # SQL Injection
  sql_injection:
    pattern: "\\$_(GET|POST|REQUEST|COOKIE)\\s*\\[[^]]+\\]\\s*\\.\\s*(query|sql|execute)"
    severity: CRITICAL
    message: "Potential SQL injection - user input used directly in query"
    fix: "Use parameterized queries or prepared statements"
    auto_fix: false

  # Hardcoded credentials
  hardcoded_credentials:
    pattern: "(password|secret|api_key|apikey|token)\\s*=\\s*['\"][^'\"]{8,}['\"]"
    severity: CRITICAL
    message: "Potential hardcoded credentials detected"
    fix: "Use environment variables or secure configuration"
    auto_fix: false
    ignore_in:
      - "*.test.*"
      - "*.example.*"

  # Missing CSRF protection
  missing_csrf:
    pattern: "<cms:form[^>]*(?!.*_token).*>"
    severity: WARNING
    message: "Form may be missing CSRF token"
    fix: "Ensure CSRF protection is enabled for the form"
    auto_fix: false

# =============================================================================
# CSS/TAILWIND CHECKS
# =============================================================================
# CSS and TailwindCSS best practices checks

css:
  # Important overuse
  important_overuse:
    pattern: "!important"
    severity: WARNING
    message: "!important should be used sparingly - it makes CSS harder to maintain"
    fix: "Use more specific selectors instead of !important"
    auto_fix: false
    threshold: 5  # Warn if more than 5 !important in file

  # Inline styles in templates
  inline_styles:
    pattern: "style\\s*=\\s*['\"][^'\"]{50,}['\"]"
    severity: INFO
    message: "Long inline style detected - consider moving to CSS file"
    fix: "Extract styles to CSS file using Tailwind utilities or custom classes"
    auto_fix: false

# =============================================================================
# ALPINE.JS CHECKS
# =============================================================================
# Alpine.js integration and best practices checks

alpinejs:
  # Missing x-cloak
  missing_xcloak:
    pattern: "x-show\\s*=(?![\\s\\S]*x-cloak)"
    severity: INFO
    message: "Element with x-show may flash on page load without x-cloak"
    fix: "Add x-cloak attribute to prevent FOUC"
    auto_fix: false

  # Complex inline expressions
  complex_inline_expression:
    pattern: "x-(on|bind|data)\\s*=\\s*['\"][^'\"]{100,}['\"]"
    severity: WARNING
    message: "Complex inline Alpine expression - consider extracting to component"
    fix: "Move logic to a named Alpine component"
    auto_fix: false

# =============================================================================
# GENERAL CODE QUALITY
# =============================================================================
# General code quality and maintainability checks

general:
  # Very long lines
  long_lines:
    pattern: "^.{200,}$"
    severity: INFO
    message: "Line exceeds 200 characters - consider breaking into multiple lines"
    fix: "Break long lines for readability"
    auto_fix: false

  # TODO comments without context
  todo_without_context:
    pattern: "//\\s*TODO\\s*$|#\\s*TODO\\s*$"
    severity: INFO
    message: "TODO comment without description"
    fix: "Add description: TODO: Implement feature X"
    auto_fix: false

  # Debug code markers
  debug_markers:
    pattern: "DEBUG|FIXME|HACK|XXX"
    severity: WARNING
    message: "Debug marker found - review before committing"
    fix: "Address the issue or remove the marker"
    auto_fix: false

# =============================================================================
# EXECUTION CONFIGURATION
# =============================================================================
# How pre-flight checks are executed and which files to check
#
# Schema:
#   block_on: array<string> - Severity levels that block code generation
#   warn_on: array<string> - Severity levels that show warnings
#   inform_on: array<string> - Severity levels that only inform
#   global_ignore: array<string> - Glob patterns to skip entirely

execution:
  # Stop execution on these severity levels
  block_on:
    - CRITICAL  # Must fix before proceeding
    - ERROR     # Must fix before proceeding

  # Show warning but continue
  warn_on:
    - WARNING   # Shows warning, asks for confirmation

  # Inform only, no pause
  inform_on:
    - INFO      # Logs information, no blocking

  # Skip checks in these paths (glob patterns)
  global_ignore:
    - "node_modules/**"    # Dependencies
    - "vendor/**"          # PHP dependencies
    - "dist/**"            # Build output
    - ".git/**"            # Git metadata
    - "*.min.js"           # Minified JavaScript
    - "*.min.css"          # Minified CSS

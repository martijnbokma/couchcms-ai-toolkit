<script>
    /**
     * Shared wizard navigation functions
     * Used across all wizard steps for consistent behavior
     */

    /**
     * Navigate to a specific step in the wizard
     * Collects current form data to preserve state
     */
    function navigateToStep(stepNum, route, setupType) {
        console.log('Navigating to step', stepNum, 'route:', route, 'setupType:', setupType)

        // Collect current form data from the page
        const form = document.querySelector('form')
        const params = new URLSearchParams()

        params.append('setupType', setupType || 'simple')

        if (form) {
            // Always get project info (available from step 1)
            const projectName = form.querySelector('input[name="projectName"]')?.value || 'my-project'
            const projectDescription = form.querySelector('input[name="projectDescription"]')?.value || 'A CouchCMS web application'
            params.append('projectName', projectName)
            params.append('projectDescription', projectDescription)

            // Get frontend selections (if extended and target step is 2 or later, OR if we're going back)
            // Always collect frontend data if we're on extended setup and have frontend fields
            const hasFrontendFields = form.querySelector('input[name="css"]') !== null || form.querySelector('input[name="js"]') !== null
            if (setupType === 'extended' && (stepNum >= 2 || hasFrontendFields)) {
                // Try to get from hidden fields first
                const cssHidden = Array.from(form.querySelectorAll('input[name="css"][type="hidden"]')).map(i => i.value).filter(v => v)
                const jsHidden = Array.from(form.querySelectorAll('input[name="js"][type="hidden"]')).map(i => i.value).filter(v => v)

                // If no hidden fields, try checkboxes
                const cssCheckboxes = cssHidden.length > 0 ? cssHidden : Array.from(form.querySelectorAll('input[name="css"][type="checkbox"]:checked')).map(i => i.value).filter(v => v)
                const jsCheckboxes = jsHidden.length > 0 ? jsHidden : Array.from(form.querySelectorAll('input[name="js"][type="checkbox"]:checked')).map(i => i.value).filter(v => v)

                cssCheckboxes.forEach(c => params.append('css', c))
                jsCheckboxes.forEach(j => params.append('js', j))
            }

            // Get editor selections
            // For simple: step 2+, for extended: step 3+
            const editorsStep = setupType === 'simple' ? 2 : 3
            // Check if we're on advanced step (step 4) - it always has editors in hidden fields
            const isOnAdvancedStep = form.querySelector('input[name="framework"]') !== null

            // Always collect editors if:
            // 1. Going to editors step or later, OR
            // 2. Currently on advanced step (going back), OR
            // 3. Form has editors fields (hidden or checkboxes)
            if (stepNum >= editorsStep || isOnAdvancedStep || form.querySelector('input[name="editors"]') !== null) {
                // Try hidden fields first (for back navigation from advanced step)
                const editorsHidden = Array.from(form.querySelectorAll('input[name="editors"][type="hidden"]')).map(i => i.value).filter(v => v)
                // Then try checkboxes (for editors step itself)
                const editorsCheckboxes = editorsHidden.length > 0 ? editorsHidden : Array.from(form.querySelectorAll('input[name="editors"][type="checkbox"]:checked')).map(i => i.value).filter(v => v)

                console.log('Collecting editors data:', { editorsHidden, editorsCheckboxes, isOnAdvancedStep })
                editorsCheckboxes.forEach(ed => params.append('editors', ed))
            }

            // Get advanced options (if extended and we're on advanced step OR going to step 4+)
            // Check if we're currently on the advanced step by looking for advanced form fields
            const isOnAdvancedStep = form.querySelector('input[name="framework"]') !== null
            if (setupType === 'extended' && (isOnAdvancedStep || stepNum >= 4)) {
                const framework = form.querySelector('input[name="framework"]')?.checked || false
                const frameworkDoctrine = form.querySelector('input[name="framework_doctrine"]')?.checked || false
                const frameworkDirectives = form.querySelector('input[name="framework_directives"]')?.checked || false
                const frameworkPlaybooks = form.querySelector('input[name="framework_playbooks"]')?.checked || false
                const frameworkEnhancements = form.querySelector('input[name="framework_enhancements"]')?.checked || false
                const contextDir = 'config/context' // Fixed path for consistency

                if (framework) {
                    params.append('framework', 'true')
                    if (frameworkDoctrine) params.append('framework_doctrine', 'true')
                    if (frameworkDirectives) params.append('framework_directives', 'true')
                    if (frameworkPlaybooks) params.append('framework_playbooks', 'true')
                    if (frameworkEnhancements) params.append('framework_enhancements', 'true')
                }
                params.append('contextDir', contextDir)
            }
        } else {
            // If no form, try to get data from URL params
            const urlParams = new URLSearchParams(window.location.search)
            urlParams.forEach((value, key) => {
                if (key !== 'step' && key !== 'route') {
                    params.append(key, value)
                }
            })
        }

        // Navigate to the step
        const url = `/api/setup/step/${route}?${params.toString()}`
        console.log('HTMX request URL:', url)
        console.log('Params:', params.toString())

        htmx.ajax('GET', url, {
            target: '#wizard-content',
            swap: 'innerHTML',
            headers: {
                'HX-Request': 'true'
            }
        }).catch(error => {
            console.error('HTMX navigation error:', error)
            alert('Error navigating to step ' + stepNum + '. Please try again.')
        })
    }

    /**
     * Universal back button handler
     * Uses HTMX to navigate back with form data preservation
     */
    function goBack(backRoute, formData = {}) {
        // Get all form data from current form
        const form = document.querySelector('form')
        if (form) {
            const formDataObj = new FormData(form)
            for (const [key, value] of formDataObj.entries()) {
                formData[key] = value
            }
        }

        // Use HTMX to navigate back
        if (backRoute) {
            htmx.ajax('POST', backRoute, {
                target: '#wizard-content',
                swap: 'innerHTML',
                values: formData
            })
        }
    }

    /**
     * HTMX error handling
     */
    document.body.addEventListener('htmx:responseError', function(event) {
        console.error('HTMX Error:', event.detail)
        alert('An error occurred while submitting the form. Please try again.')
    })

    document.body.addEventListener('htmx:sendError', function(event) {
        console.error('HTMX Send Error:', event.detail)
        alert('An error occurred while submitting the form. Please check your internet connection.')
    })

    // Debug: Log all HTMX events for troubleshooting
    document.body.addEventListener('htmx:beforeRequest', function(event) {
        console.log('HTMX beforeRequest:', event.detail)
    })

    document.body.addEventListener('htmx:afterRequest', function(event) {
        console.log('HTMX afterRequest:', event.detail)
    })

    document.body.addEventListener('htmx:beforeSwap', function(event) {
        console.log('HTMX beforeSwap:', event.detail)
    })

    document.body.addEventListener('htmx:afterSwap', function(event) {
        console.log('HTMX afterSwap - Content swapped successfully')
    })

    // Make functions available globally
    window.navigateToStep = navigateToStep
    window.goBack = goBack

    // Fallback: Add event listeners to all step buttons as backup
    // This ensures navigation works even if onclick fails
    document.addEventListener('DOMContentLoaded', function() {
        // Re-bind click handlers after HTMX swaps
        document.body.addEventListener('htmx:afterSwap', function() {
            const stepButtons = document.querySelectorAll('[data-step][data-route]')
            stepButtons.forEach(button => {
                const stepNum = parseInt(button.getAttribute('data-step'))
                const route = button.getAttribute('data-route')
                const setupType = button.closest('[data-setup-type]')?.getAttribute('data-setup-type') ||
                                 document.querySelector('[data-setup-type]')?.getAttribute('data-setup-type') ||
                                 'extended'

                // Remove existing listeners and add new one
                button.removeEventListener('click', handleStepClick)
                button.addEventListener('click', function(e) {
                    e.preventDefault()
                    e.stopPropagation()
                    navigateToStep(stepNum, route, setupType)
                })
            })
        })

        // Initial bind
        const stepButtons = document.querySelectorAll('[data-step][data-route]')
        stepButtons.forEach(button => {
            const stepNum = parseInt(button.getAttribute('data-step'))
            const route = button.getAttribute('data-route')
            const setupType = button.closest('[data-setup-type]')?.getAttribute('data-setup-type') ||
                             document.querySelector('[data-setup-type]')?.getAttribute('data-setup-type') ||
                             'extended'

            button.addEventListener('click', function(e) {
                e.preventDefault()
                e.stopPropagation()
                navigateToStep(stepNum, route, setupType)
            })
        })
    })

    function handleStepClick(e) {
        e.preventDefault()
        e.stopPropagation()
        const stepNum = parseInt(this.getAttribute('data-step'))
        const route = this.getAttribute('data-route')
        const setupType = this.closest('[data-setup-type]')?.getAttribute('data-setup-type') ||
                         document.querySelector('[data-setup-type]')?.getAttribute('data-setup-type') ||
                         'extended'
        navigateToStep(stepNum, route, setupType)
    }
</script>

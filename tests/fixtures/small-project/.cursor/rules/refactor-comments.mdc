---
description: Auto-load refactoring rules for CouchCMS comments
globs: ['{{paths.snippets}}/**/*comment*.html', '*.php']
alwaysApply: false
---

# Refactoring Rules for CouchCMS Comments

## ğŸš¨ CRITICAL: Refactoring Workflow

**When a refactoring request is made (e.g., "refactor @file.html" for comments), you MUST:**

1. **First**: Load and follow `@ai-toolkit-shared/prompts/refactoring/router.md`
2. **Router will**: Analyze the file, select appropriate specialist(s), request confirmation
3. **Then**: Apply the rules below as part of the selected specialist workflow

**Never skip the router analysis step - it ensures the correct specialist is selected.**

---

When refactoring this file, apply these rules:

## Template Configuration

- âœ… Enable comments: `commentable='1'` in template tag
- âœ… Check `k_is_commentable` before showing comment form
- âœ… Comments typically only in page view
- âŒ Never forget `commentable='1'` attribute

## Comment Form

- âœ… Use `<cms:form method="post">` for comment submission
- âœ… Call `<cms:process_comment />` in `k_success` block
- âœ… Check `k_process_comment_success` for success
- âœ… Display `k_process_comment_error` for errors
- âœ… Handle form errors with `k_error` variable

## Form Fields

- âœ… Show name/email/website fields only for logged-out users
- âœ… Use `k_logged_out` to conditionally show fields
- âœ… Use `k_author`, `k_email`, `k_link` for logged-out users
- âœ… Use `k_comment` for comment text (required)
- âœ… Show logged-in user info for authenticated users

## CAPTCHA

- âœ… Require CAPTCHA for logged-out users
- âœ… Use `<cms:input type="captcha" name="captcha" format='i-r-t' />`
- âœ… Only show CAPTCHA when `k_logged_out`
- âœ… Validate CAPTCHA in form processing
- âŒ Never skip CAPTCHA for public comments

## Comment Display

- âœ… Use `<cms:comments>` tag to list comments
- âœ… Set `page_id=k_page_id` for page-specific comments
- âœ… Use pagination for large comment sets
- âœ… Display comment variables: `k_comment_author`, `k_comment`, `k_comment_date`
- âœ… Use `k_comment_link` and `k_comment_anchor` for direct links

## Comment Variables

- âœ… Use `k_comment_author` for commenter name
- âœ… Use `k_comment_author_website` for website link
- âœ… Use `k_comment` for comment text
- âœ… Use `k_comment_date` for comment date
- âœ… Use `k_comment_author_initial` for avatar placeholder

## Pagination

- âœ… Use `paginate='1'` for large comment sets
- âœ… Display pagination info with `k_paginated_top` and `k_paginated_bottom`
- âœ… Show comment count: `k_total_records`
- âœ… Use `<cms:paginator />` for navigation
- âœ… Check `k_paginator_required` before showing pagination

## Spam Prevention

- âœ… Set `K_COMMENTS_REQUIRE_APPROVAL` to `1` in config
- âœ… Set `K_COMMENTS_INTERVAL` (recommended: 300 seconds)
- âœ… Require CAPTCHA for logged-out users
- âœ… Validate all form fields
- âœ… Use email validation for email field

## Error Handling

- âœ… Check `k_error` for form validation errors
- âœ… Check `k_process_comment_error` for processing errors
- âœ… Display field-specific errors: `k_error_k_author`, `k_error_k_email`
- âœ… Show helpful error messages
- âœ… Handle all error cases gracefully

## Success Feedback

- âœ… Show success message after comment submission
- âœ… Inform users comment awaits moderation
- âœ… Clear form after successful submission
- âœ… Provide clear feedback to user

## Empty State

- âœ… Check `k_total_records='0'` for no comments
- âœ… Display helpful message when no comments exist
- âœ… Encourage first comment
- âœ… Show comment form even when no comments

## Comment Order

- âœ… Use `order='asc'` for chronological display
- âœ… Use `order='desc'` for newest first
- âœ… Choose order based on UX requirements
- âœ… Maintain consistent ordering

## Security

- âœ… Always validate comment input
- âœ… Sanitize comment output
- âœ… Use `rel="external nofollow"` for commenter websites
- âœ… Require approval for all comments
- âœ… Set comment interval to prevent flooding

## Checklist

- [ ] Template has `commentable='1'` attribute
- [ ] Comment form checks `k_is_commentable`
- [ ] `process_comment` tag called in `k_success` block
- [ ] CAPTCHA required for logged-out users
- [ ] Form fields conditionally shown based on login status
- [ ] Comment display uses `<cms:comments>` tag
- [ ] Pagination implemented for large comment sets
- [ ] Spam prevention measures in place
- [ ] Error handling implemented
- [ ] Success feedback shown
- [ ] Empty state handled
- [ ] Comment order specified
- [ ] Security measures applied
- [ ] Comment variables used correctly

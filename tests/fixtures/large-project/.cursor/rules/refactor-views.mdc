---
description: Auto-load refactoring rules for CouchCMS views
globs: ['{{paths.views}}/**/*.html', '*.php']
alwaysApply: false
---

# Refactoring Rules for CouchCMS Views

## ğŸš¨ CRITICAL: Refactoring Workflow

**When a refactoring request is made (e.g., "refactor @file.html" for views), you MUST:**

1. **First**: Load and follow `@ai-toolkit-shared/prompts/refactoring/router.md`
2. **Router will**: Analyze the file, select appropriate specialist(s), request confirmation
3. **Then**: Apply the rules below as part of the selected specialist workflow

**Never skip the router analysis step - it ensures the correct specialist is selected.**

---

When refactoring this file, apply these rules:

## View Detection

- âœ… Always check view type before displaying content
- âœ… Use `k_is_page` for single page display
- âœ… Use `k_is_list` for any listing
- âœ… Distinguish between home, folder, and archive views
- âœ… Use `k_is_home`, `k_is_folder`, `k_is_archive` for specific list types
- âŒ Never assume view type without checking

## View Structure

- âœ… Use `cms:if k_is_page` for page view content
- âœ… Use `cms:else` for list view content
- âœ… Handle all view types: page, home, folder, archive
- âœ… Use consistent layout structure across views
- âœ… Place views in `{{paths.views}}/` directory

## Page View Patterns

- âœ… Display single page content with `k_page_title`, `k_page_content`
- âœ… Show page metadata: `k_page_date`, `k_page_excerpt`
- âœ… Provide navigation: back to list, next/previous page
- âœ… Use `k_prev_page_link` and `k_next_page_link` for navigation
- âœ… Display comments only in page view (if applicable)

## List View Patterns

- âœ… Use `<cms:pages>` for listing pages
- âœ… Implement pagination for large result sets
- âœ… Show folder/archive headers when applicable
- âœ… Use breadcrumbs in folder and archive views
- âœ… Display appropriate meta information

## Folder View

- âœ… Check `k_is_folder` within list view
- âœ… Display `k_folder_title` and `k_folder_desc`
- âœ… Use breadcrumbs for navigation
- âœ… Filter pages by folder: `folder=k_folder_name`
- âœ… Show folder context clearly

## Archive View

- âœ… Check `k_is_archive` within list view
- âœ… Use `k_is_year`, `k_is_month`, `k_is_day` for specific archives
- âœ… Display `k_archive_date` with appropriate format
- âœ… Show archive context clearly
- âœ… Filter pages by date range when needed

## Home View

- âœ… Check `k_is_home` for home-specific content
- âœ… Distinguish from folder and archive views
- âœ… Show "All Posts" or similar header
- âœ… Display all pages (not filtered by folder/date)

## View-Specific Variables

- âœ… Use view-appropriate variables for each context
- âœ… Page view: `k_page_*` variables
- âœ… List view: `k_record_*`, `k_paginated_*` variables
- âœ… Folder view: `k_folder_*` variables
- âœ… Archive view: `k_archive_*` variables

## Navigation

- âœ… Provide clear navigation between views
- âœ… Use `k_template_link` for back to list
- âœ… Use `k_prev_page_link` and `k_next_page_link` for page navigation
- âœ… Use breadcrumbs in folder/archive views
- âœ… Make navigation accessible and user-friendly

## URL Patterns

- âœ… Understand URL mapping to views:
  - `/` â†’ Home view (list)
  - `/folder-name/` â†’ Folder view
  - `/2010/05/` â†’ Archive view
  - `/page-name.html` â†’ Page view
- âœ… Handle URL patterns correctly for each view type

## Performance

- âœ… Use pagination for list views
- âœ… Use reasonable limits (10-20 items)
- âœ… Use `limit` and `orderby` for large result sets
- âœ… Cache expensive queries when appropriate

## Checklist

- [ ] View type checked before displaying content
- [ ] All view types handled (page, home, folder, archive)
- [ ] Page view displays single page correctly
- [ ] List view displays pages with pagination
- [ ] Folder view shows folder context
- [ ] Archive view shows date context
- [ ] Navigation between views works
- [ ] Breadcrumbs in folder/archive views
- [ ] View-specific variables used correctly
- [ ] Consistent layout structure
- [ ] Performance optimizations applied
- [ ] Accessibility requirements met

---
description: Auto-load refactoring rules for DataBound Forms
globs: ['{{paths.forms}}/**/*.html', '{{paths.views}}/**/create*.html', '{{paths.views}}/**/edit*.html']
alwaysApply: false
---

# Refactoring Rules for DataBound Forms

## ğŸš¨ CRITICAL: Refactoring Workflow

**When a refactoring request is made (e.g., "refactor @file.html" for forms), you MUST:**

1. **First**: Load and follow `@ai-toolkit-shared/prompts/refactoring/router.md`
2. **Router will**: Analyze the file, select appropriate specialist(s), request confirmation
3. **Then**: Apply the rules below as part of the selected specialist workflow

**Never skip the router analysis step - it ensures the correct specialist is selected.**

---

When refactoring this file, apply these rules:

## Form Structure

- âœ… Use `enctype='multipart/form-data'` for file uploads
- âœ… Set `masterpage` and `mode` attributes
- âœ… Handle `k_success` and `k_error` properly

## Validation Placement

- âŒ Never validate on bound inputs
- âœ… Define validation on editable regions in template
- âœ… Bound inputs just bind, validation is inherited

## Security

- âœ… Use `<cms:embed '{{paths.filters}}/authenticated.html' />`
- âœ… Use ownership filters for edit/delete
- âœ… Set `content_owner=k_user_name` on create
- âœ… Add anti-spam for public forms

## Error Handling

- âœ… Display `k_error` with proper styling
- âœ… Show field-specific errors: `k_error_fieldname`
- âœ… Use flash messages for success feedback
- âœ… Add loading states during submission

## DRY Principle

- âœ… Extract form fields into reusable snippets
- âœ… Share between create and edit views
- âœ… Use `<cms:embed>` for form partials

## Form Structure & Attributes

- âœ… Use `enctype='multipart/form-data'` for file uploads
- âœ… Set `masterpage` and `mode` attributes correctly
- âœ… Use `page_id="k_page_id"` for edit forms
- âœ… Handle `k_success` and `k_error` properly
- âœ… Use `anchor="0"` for delete forms

## Validation Rules

- âŒ Never validate on bound inputs
- âœ… Define validation on editable regions in template
- âœ… Bound inputs just bind, validation is inherited
- âœ… Use `required="1"` and `validator` on editable regions
- âœ… Display field-specific errors: `k_error_fieldname`

## Security Patterns

- âœ… Use `<cms:embed '{{paths.filters}}/authenticated.html' />`
- âœ… Use ownership filters for edit/delete: `owns_content.html`
- âœ… Set `content_owner=k_user_name` on create
- âœ… Add anti-spam for public forms (honeypot, timestamp, human check)
- âœ… Check `k_user_access_level` for admin operations

## Error Handling

- âœ… Display `k_error` with proper styling (alert component)
- âœ… Show field-specific errors: `k_error_fieldname`
- âœ… Use flash messages for success feedback
- âœ… Add loading states during submission
- âœ… Handle validation errors gracefully

## Multi-Step Forms

- âœ… Use Alpine.js for step navigation
- âœ… Show progress with steps component
- âœ… Validate each step before proceeding
- âœ… Persist form data between steps
- âœ… Show review step before final submission

## Repeatable Form Fields

- âœ… Use Alpine.js for dynamic field management
- âœ… Serialize repeatable data to JSON
- âœ… Use `frm_*` variables for form persistence
- âœ… Validate repeatable items before submission
- âœ… Handle empty repeatable regions

## Auto-Save Drafts

- âœ… Use localStorage for draft persistence
- âœ… Auto-save on input changes (debounced)
- âœ… Clear draft on successful submission
- âœ… Restore draft on page load
- âœ… Show draft indicator to user

## Anti-Spam Protection

- âœ… Add honeypot field (hidden from users)
- âœ… Use timestamp for bot detection
- âœ… Add human verification (simple math question)
- âœ… Check all anti-spam measures in `k_success` block
- âœ… Abort form processing if spam detected

## Form Persistence

- âœ… Use `_invalidate_cache="1"` on form save
- âœ… Redirect after successful submission
- âœ… Use flash messages for user feedback
- âœ… Handle form resubmission (PRG pattern)

## Checklist

- [ ] `enctype='multipart/form-data'` for file uploads
- [ ] Validation on editable regions (not inputs)
- [ ] Authentication filter present
- [ ] Ownership check on edit/delete
- [ ] Setting `content_owner` on create
- [ ] Error display with `k_error` and field-specific errors
- [ ] Success feedback with flash messages
- [ ] Reusable form snippets (DRY)
- [ ] Anti-spam measures for public forms
- [ ] Loading states during submission
- [ ] Multi-step forms use Alpine.js navigation
- [ ] Repeatable fields properly serialized
- [ ] Auto-save drafts implemented (if needed)
- [ ] Cache invalidation on form save
- [ ] Proper redirect after submission



name: PR Checks

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  validate:
    name: Validate Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Run validation
        run: bun scripts/validate.js

  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Check for syntax errors
        run: |
          echo "Checking JavaScript files for syntax errors..."
          find scripts -name "*.js" -type f -exec node --check {} \;

  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR target branch
        run: |
          TARGET_BRANCH="${{ github.base_ref }}"
          SOURCE_BRANCH="${{ github.head_ref }}"
          
          echo "üìã PR Information:"
          echo "  Source: $SOURCE_BRANCH"
          echo "  Target: $TARGET_BRANCH"
          
          # Validate branch naming
          if [[ $SOURCE_BRANCH == feature/* ]]; then
            if [[ $TARGET_BRANCH != "develop" ]]; then
              echo "‚ùå Error: Feature branches must target 'develop'"
              exit 1
            fi
          elif [[ $SOURCE_BRANCH == release/* ]]; then
            if [[ $TARGET_BRANCH != "main" && $TARGET_BRANCH != "develop" ]]; then
              echo "‚ùå Error: Release branches must target 'main' or 'develop'"
              exit 1
            fi
          elif [[ $SOURCE_BRANCH == hotfix/* ]]; then
            if [[ $TARGET_BRANCH != "main" && $TARGET_BRANCH != "develop" ]]; then
              echo "‚ùå Error: Hotfix branches must target 'main' or 'develop'"
              exit 1
            fi
          fi
          
          echo "‚úÖ Branch targeting is correct"

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<<<'; then
            echo "‚ùå Merge conflicts detected"
            exit 1
          fi
          echo "‚úÖ No merge conflicts"

  summary:
    name: Checks Summary
    runs-on: ubuntu-latest
    needs: [validate, lint, pr-info]
    if: always()
    
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.validate.result }}" == "failure" ]] || \
             [[ "${{ needs.lint.result }}" == "failure" ]] || \
             [[ "${{ needs.pr-info.result }}" == "failure" ]]; then
            echo "‚ùå Some checks failed"
            exit 1
          fi
          echo "‚úÖ All checks passed!"

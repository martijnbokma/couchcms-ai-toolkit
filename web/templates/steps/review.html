<div>
    {% set sectionTitle = 'Review Configuration' %}
    {% set sectionDescription = 'Review your settings before generating the configuration.' %}
    {% include "partials/section-header.html" %}

    <div class="space-y-3 sm:space-y-4 mb-6 sm:mb-8">
        <!-- Project Information -->
        <div class="relative flex flex-col h-full px-4 sm:px-5 py-3 sm:py-4 bg-base-200/50 shadow-sm border border-base-300 rounded-xl hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                    <h3 class="flex items-center gap-2 text-base sm:text-lg font-semibold mb-3 text-base-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 shrink-0 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        Project Information
                    </h3>
                    <div class="space-y-2.5 mt-2">
                        <div class="flex flex-col sm:flex-row items-start gap-1.5 sm:gap-3">
                            <span class="text-xs sm:text-sm font-semibold text-base-content/70 sm:min-w-[140px] uppercase tracking-wide">Name:</span>
                            <span class="text-sm sm:text-base text-base-content font-medium break-words">{{ projectName }}</span>
                        </div>
                        <div class="flex flex-col sm:flex-row items-start gap-1.5 sm:gap-3">
                            <span class="text-xs sm:text-sm font-semibold text-base-content/70 sm:min-w-[140px] uppercase tracking-wide">Description:</span>
                            <span class="text-sm sm:text-base text-base-content/80 break-words">{{ projectDescription }}</span>
                        </div>
                    </div>
                </div>
                <button type="button" data-edit-step="1" data-edit-route="project" onclick="editStep(this)" class="btn btn-sm btn-ghost btn-circle text-base-content/60 hover:text-primary hover:bg-primary/10 active:bg-primary/20 transition-colors shrink-0 min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0" aria-label="Edit Project Information">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Selected Preset -->
        {% if preset and preset != '' %}
        <div class="relative flex flex-col h-full px-4 sm:px-5 py-3 sm:py-4 bg-base-200/50 shadow-sm border border-primary/30 rounded-xl hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                    <h3 class="flex items-center gap-2 text-base sm:text-lg font-semibold mb-3 text-base-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 shrink-0 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Selected Preset
                    </h3>
                    <div class="space-y-2.5 mt-2">
                        <div class="flex flex-col sm:flex-row items-start gap-1.5 sm:gap-3">
                            <span class="text-xs sm:text-sm font-semibold text-base-content/70 sm:min-w-[140px] uppercase tracking-wide">Preset:</span>
                            <span class="badge badge-primary badge-lg text-sm font-semibold">{{ presetData.name if presetData else preset }}</span>
                        </div>
                        {% if presetData and presetData.description %}
                        <div class="flex flex-col sm:flex-row items-start gap-1.5 sm:gap-3">
                            <span class="text-xs sm:text-sm font-semibold text-base-content/70 sm:min-w-[140px] uppercase tracking-wide">Description:</span>
                            <span class="text-sm sm:text-base text-base-content/80 break-words">{{ presetData.description }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% if setupType == 'extended' %}
                <button type="button" data-edit-step="2" data-edit-route="presets" onclick="editStep(this)" class="btn btn-sm btn-ghost btn-circle text-base-content/60 hover:text-primary hover:bg-primary/10 active:bg-primary/20 transition-colors shrink-0 min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0" aria-label="Edit Preset">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </button>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Frontend Frameworks (only for extended) -->
        {% if setupType == 'extended' %}
        <div class="relative flex flex-col h-full px-3 sm:px-4 py-2.5 sm:py-3 bg-base-200 shadow-sm border border-base-300 rounded-xl">
            <div class="flex items-start justify-between gap-2">
                <div class="flex-1">
                    <h3 class="flex items-center gap-2 text-base sm:text-lg font-semibold mb-2 sm:mb-3 text-base-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                        </svg>
                        Frontend Frameworks
                    </h3>
                    {% if frontend.css|length > 0 or frontend.js|length > 0 %}
                    <div class="flex flex-wrap gap-2 mt-2">
                        {% for css in frontend.css %}
                        <span class="badge badge-primary badge-sm">{{ css }}</span>
                        {% endfor %}
                        {% for js in frontend.js %}
                        {% if js not in frontend.css %}
                        <span class="badge badge-secondary badge-sm">{{ js }}</span>
                        {% endif %}
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-xs sm:text-sm text-base-content/60 mt-2">No frontend frameworks selected</p>
                    {% endif %}
                </div>
                <button type="button" data-edit-step="3" data-edit-route="frontend" onclick="editStep(this)" class="btn btn-sm btn-ghost btn-circle text-base-content/60 hover:text-primary hover:bg-primary/10 active:bg-primary/20 transition-colors shrink-0 min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0" aria-label="Edit Frontend Frameworks">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- AI Agents (only for extended) -->
        {% if agents|length > 0 %}
        <div class="relative flex flex-col h-full px-4 sm:px-5 py-3 sm:py-4 bg-base-200/50 shadow-sm border border-base-300 rounded-xl hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                    <h3 class="flex items-center gap-2 text-base sm:text-lg font-semibold mb-3 text-base-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 shrink-0 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                        AI Agents
                    </h3>
                    <div class="flex flex-wrap gap-2 mt-2">
                        {% for agent in agents %}
                        <span class="badge badge-primary badge-md font-medium">{{ agent }}</span>
                        {% endfor %}
                    </div>
                </div>
                <button type="button" data-edit-step="4" data-edit-route="agents" onclick="editStep(this)" class="btn btn-sm btn-ghost btn-circle text-base-content/60 hover:text-primary hover:bg-primary/10 active:bg-primary/20 transition-colors shrink-0 min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0" aria-label="Edit AI Agents">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </button>
            </div>
        </div>
        {% endif %}
        {% endif %}


        <!-- Editors -->
        <div class="relative flex flex-col h-full px-4 sm:px-5 py-3 sm:py-4 bg-base-200/50 shadow-sm border border-base-300 rounded-xl hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                    <h3 class="flex items-center gap-2 text-base sm:text-lg font-semibold mb-3 text-base-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 shrink-0 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        Editors & AI Tools
                    </h3>
                    {% if editors|length > 0 %}
                    <div class="flex flex-wrap gap-2 mt-2">
                        {% for editor in editors %}
                        <span class="badge badge-info badge-md font-medium">{{ editor }}</span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm sm:text-base text-base-content/60 mt-2 italic">No editors selected - configuration files will not be generated</p>
                    {% endif %}
                </div>
                <button type="button" data-edit-step="{{ '2' if setupType == 'simple' else '5' }}" data-edit-route="editors" onclick="editStep(this)" class="btn btn-sm btn-ghost btn-circle text-base-content/60 hover:text-primary hover:bg-primary/10 active:bg-primary/20 transition-colors shrink-0 min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0" aria-label="Edit Editors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Advanced Options (only for extended) -->
        {% if setupType == 'extended' %}
        <div class="relative flex flex-col h-full px-4 sm:px-5 py-3 sm:py-4 bg-base-200/50 shadow-sm border border-base-300 rounded-xl hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                    <h3 class="flex items-center gap-2 text-base sm:text-lg font-semibold mb-3 text-base-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 shrink-0 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        CADS Framework
                        <span class="text-xs sm:text-sm text-base-content/60 font-normal ml-2">(CouchCMS AI Development Standards)</span>
                    </h3>
                    {% if framework %}
                    <div class="flex flex-wrap gap-2 mt-2">
                        {% if framework.doctrine %}<span class="badge badge-success badge-md font-medium">Doctrine</span>{% endif %}
                        {% if framework.directives %}<span class="badge badge-success badge-md font-medium">Directives</span>{% endif %}
                        {% if framework.playbooks %}<span class="badge badge-success badge-md font-medium">Playbooks</span>{% endif %}
                        {% if framework.enhancements %}<span class="badge badge-success badge-md font-medium">Enhancements</span>{% endif %}
                    </div>
                    {% else %}
                    <p class="text-sm sm:text-base text-base-content/60 mt-2 italic">CADS Framework is not enabled</p>
                    {% endif %}
                </div>
                <button type="button" data-edit-step="6" data-edit-route="advanced" onclick="editStep(this)" class="btn btn-sm btn-ghost btn-circle text-base-content/60 hover:text-primary hover:bg-primary/10 active:bg-primary/20 transition-colors shrink-0 min-w-[44px] min-h-[44px] sm:min-w-0 sm:min-h-0" aria-label="Edit Advanced Options">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                    </svg>
                </button>
            </div>
        </div>
        {% endif %}

        <!-- CouchCMS Modules (automatic - read-only) - Compact with modal -->
        <div class="relative flex flex-col h-full px-4 sm:px-5 py-3 sm:py-4 bg-base-200/50 shadow-sm border border-base-300 rounded-xl hover:shadow-md transition-shadow">
            <div class="flex items-start justify-between gap-3">
                <div class="flex-1 min-w-0">
                    <h3 class="flex items-center gap-2 text-base sm:text-lg font-semibold mb-2 text-base-content">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 sm:h-6 sm:w-6 shrink-0 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        CouchCMS Modules
                        <span class="badge badge-ghost badge-sm ml-2">Auto-included</span>
                    </h3>
                    <div class="flex items-center gap-3 mt-1">
                        <span class="text-xs sm:text-sm text-base-content/70">
                            <span class="font-semibold">{{ enrichedModules|length if enrichedModules else couchcmsModules|length }}</span> core module{{ 's' if (enrichedModules|length if enrichedModules else couchcmsModules|length) != 1 else '' }},
                            <span class="font-semibold">{{ enrichedAgents|length if enrichedAgents else couchcmsAgents|length }}</span> core agent{{ 's' if (enrichedAgents|length if enrichedAgents else couchcmsAgents|length) != 1 else '' }}
                        </span>
                        <span class="text-xs text-base-content/50 italic">automatically included</span>
                    </div>
                </div>
                <button type="button" onclick="document.getElementById('couchcms-modules-modal').showModal()" class="btn btn-sm btn-ghost text-xs shrink-0 min-h-[44px] sm:min-h-0 active:bg-primary/20" aria-label="View CouchCMS Modules Details">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Details
                </button>
            </div>
        </div>

        <!-- Modal for CouchCMS Modules Details -->
        <dialog id="couchcms-modules-modal" class="modal modal-middle">
            <div class="modal-box w-11/12 max-w-4xl p-0 flex flex-col max-h-[90vh]">
                <!-- Header - Fixed -->
                <div class="px-6 pt-6 pb-4 border-b border-base-300 flex-shrink-0">
                    <div class="flex items-start justify-between gap-4 mb-4">
                        <div class="flex-1">
                            <h3 class="font-bold text-xl sm:text-2xl mb-2 flex items-center gap-2 text-base-content">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-primary shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                                </svg>
                                CouchCMS Modules & Agents
                                <span class="badge badge-ghost badge-sm ml-2">Auto-included</span>
                            </h3>
                            <p class="text-sm text-base-content/70">
                                All core modules and agents available in the toolkit
                            </p>
                        </div>
                        <form method="dialog">
                            <button class="btn btn-sm btn-circle btn-ghost text-base-content/60 hover:text-base-content hover:bg-base-200" aria-label="Close modal">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </form>
                    </div>

                    <!-- Tabs and Search -->
                    <div class="flex items-center gap-4">
                        <div class="tabs tabs-boxed flex-1" role="tablist">
                            <button class="tab tab-active" role="tab" aria-selected="true" data-tab="modules" onclick="switchTab('modules')">
                                Modules
                                <span class="badge badge-sm ml-2">{{ enrichedModules|length if enrichedModules else couchcmsModules|length }}</span>
                            </button>
                            <button class="tab" role="tab" aria-selected="false" data-tab="agents" onclick="switchTab('agents')">
                                Agents
                                <span class="badge badge-sm ml-2">{{ enrichedAgents|length if enrichedAgents else couchcmsAgents|length }}</span>
                            </button>
                        </div>
                        <!-- Search Input -->
                        <div class="form-control">
                            <input
                                type="text"
                                id="module-agent-search"
                                placeholder="Search..."
                                class="input input-bordered input-sm w-48"
                                oninput="filterItems(this.value)"
                            />
                        </div>
                    </div>
                </div>

                <!-- Scrollable Content Area -->
                <div class="flex-1 overflow-y-auto px-6 py-4">
                <!-- Modules Tab Content -->
                <div id="modules-tab-content" class="tab-content">
                    {% if enrichedModules and enrichedModules|length > 0 %}
                        {% if modulesByCategory %}
                            {% for category, modules in modulesByCategory %}
                            <div class="mb-6">
                                <h4 class="font-semibold text-sm text-base-content flex items-center gap-2 mb-3 sticky top-0 bg-base-100 py-2 z-10">
                                    {% if category == 'core' %}
                                    <span class="badge badge-error badge-xs">Core</span>
                                    {% elif category == 'navigation' %}
                                    <span class="badge badge-info badge-xs">Navigation</span>
                                    {% elif category == 'content' %}
                                    <span class="badge badge-success badge-xs">Content</span>
                                    {% elif category == 'frontend' %}
                                    <span class="badge badge-secondary badge-xs">Frontend</span>
                                    {% else %}
                                    <span class="badge badge-neutral badge-xs">{{ category|title }}</span>
                                    {% endif %}
                                    {{ category|title }} Modules
                                    <span class="text-xs font-normal text-base-content/50 ml-auto">({{ modules|length }})</span>
                                </h4>
                                <div class="space-y-2">
                                    {% for module in modules %}
                                    <div class="item-card flex items-center justify-between gap-3 p-3 bg-base-200/50 border border-base-300 rounded-lg hover:border-primary/30 hover:bg-base-200 transition-all cursor-pointer group" data-name="{{ module.name|lower }}" data-description="{{ (module.description or '')|lower }}" onclick="showItemDetails('module', '{{ module.name }}')">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-1">
                                                <h5 class="font-semibold text-sm text-base-content">
                                                    {{ module.name }}
                                                </h5>
                                                {% if module.required %}
                                                <span class="badge badge-error badge-xs">Required</span>
                                                {% endif %}
                                                {% if module.version %}
                                                <span class="badge badge-ghost badge-xs">v{{ module.version }}</span>
                                                {% endif %}
                                            </div>
                                            {% if module.description %}
                                            <p class="text-xs text-base-content/60 line-clamp-1">
                                                {{ module.description }}
                                            </p>
                                            {% endif %}
                                        </div>
                                        <button
                                            type="button"
                                            class="btn btn-xs btn-ghost btn-circle opacity-0 group-hover:opacity-100 transition-opacity shrink-0"
                                            onclick="event.stopPropagation(); showItemDetails('module', '{{ module.name }}')"
                                            aria-label="View {{ module.name }} details"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <!-- Show all enriched modules if not grouped -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-sm text-base-content flex items-center gap-2 mb-3">
                                <span class="badge badge-neutral badge-xs">All</span>
                                Core Modules
                                <span class="text-xs font-normal text-base-content/50 ml-auto">({{ enrichedModules|length }})</span>
                            </h4>
                            <div class="space-y-2">
                                {% for module in enrichedModules %}
                                <div class="item-card flex items-center justify-between gap-3 p-3 bg-base-200/50 border border-base-300 rounded-lg hover:border-primary/30 hover:bg-base-200 transition-all cursor-pointer group" data-name="{{ module.name|lower }}" data-description="{{ (module.description or '')|lower }}" onclick="showItemDetails('module', '{{ module.name }}')">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <h5 class="font-semibold text-sm text-base-content">{{ module.name }}</h5>
                                            {% if module.required %}<span class="badge badge-error badge-xs">Required</span>{% endif %}
                                            {% if module.version %}<span class="badge badge-ghost badge-xs">v{{ module.version }}</span>{% endif %}
                                        </div>
                                        {% if module.description %}
                                        <p class="text-xs text-base-content/60 line-clamp-1">{{ module.description }}</p>
                                        {% endif %}
                                    </div>
                                    <button type="button" class="btn btn-xs btn-ghost btn-circle opacity-0 group-hover:opacity-100 transition-opacity shrink-0" onclick="event.stopPropagation(); showItemDetails('module', '{{ module.name }}')" aria-label="View {{ module.name }} details">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% elif couchcmsModules and couchcmsModules|length > 0 %}
                        <!-- Fallback to simple list -->
                        <div class="space-y-2">
                            {% for module in couchcmsModules %}
                            <div class="item-card flex items-center justify-between gap-3 p-3 bg-base-200/50 border border-base-300 rounded-lg hover:border-primary/30 hover:bg-base-200 transition-all cursor-pointer" data-name="{{ module|lower }}" onclick="showItemDetails('module', '{{ module }}')">
                                <span class="font-semibold text-sm text-base-content">{{ module }}</span>
                                <button type="button" class="btn btn-xs btn-ghost btn-circle shrink-0" onclick="event.stopPropagation(); showItemDetails('module', '{{ module }}')" aria-label="View {{ module }} details">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-sm text-base-content/60 italic text-center py-8">No modules found</p>
                    {% endif %}
                </div>

                <!-- Agents Tab Content -->
                <div id="agents-tab-content" class="tab-content hidden">
                    {% if enrichedAgents and enrichedAgents|length > 0 %}
                        {% if agentsByCategory %}
                            {% for category, agents in agentsByCategory %}
                            <div class="mb-6">
                                <h4 class="font-semibold text-sm text-base-content flex items-center gap-2 mb-3 sticky top-0 bg-base-100 py-2 z-10">
                                    {% if category == 'core' %}
                                    <span class="badge badge-error badge-xs">Core</span>
                                    {% elif category == 'frontend' %}
                                    <span class="badge badge-secondary badge-xs">Frontend</span>
                                    {% elif category == 'dev-tools' %}
                                    <span class="badge badge-info badge-xs">Dev Tools</span>
                                    {% else %}
                                    <span class="badge badge-neutral badge-xs">{{ category|title }}</span>
                                    {% endif %}
                                    {{ category|title }} Agents
                                    <span class="text-xs font-normal text-base-content/50 ml-auto">({{ agents|length }})</span>
                                </h4>
                                <div class="space-y-2">
                                    {% for agent in agents %}
                                    <div class="item-card flex items-center justify-between gap-3 p-3 bg-base-200/50 border border-base-300 rounded-lg hover:border-primary/30 hover:bg-base-200 transition-all cursor-pointer group" data-name="{{ agent.name|lower }}" data-description="{{ (agent.description or '')|lower }}" onclick="showItemDetails('agent', '{{ agent.name }}')">
                                        <div class="flex-1 min-w-0">
                                            <div class="flex items-center gap-2 mb-1">
                                                <h5 class="font-semibold text-sm text-base-content">
                                                    {{ agent.name }}
                                                </h5>
                                                {% if agent.type %}
                                                <span class="badge badge-primary badge-xs">{{ agent.type }}</span>
                                                {% endif %}
                                                {% if agent.version %}
                                                <span class="badge badge-ghost badge-xs">v{{ agent.version }}</span>
                                                {% endif %}
                                            </div>
                                            {% if agent.description %}
                                            <p class="text-xs text-base-content/60 line-clamp-1">
                                                {{ agent.description }}
                                            </p>
                                            {% endif %}
                                            {% if agent.tags and agent.tags|length > 0 %}
                                            <div class="flex items-center gap-1 flex-wrap mt-1">
                                                {% for tag in agent.tags %}
                                                <span class="badge badge-outline badge-xs">{{ tag }}</span>
                                                {% endfor %}
                                            </div>
                                            {% endif %}
                                        </div>
                                        <button
                                            type="button"
                                            class="btn btn-xs btn-ghost btn-circle opacity-0 group-hover:opacity-100 transition-opacity shrink-0"
                                            onclick="event.stopPropagation(); showItemDetails('agent', '{{ agent.name }}')"
                                            aria-label="View {{ agent.name }} details"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </button>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                        <!-- Show all enriched agents if not grouped -->
                        <div class="mb-6">
                            <h4 class="font-semibold text-sm text-base-content flex items-center gap-2 mb-3">
                                <span class="badge badge-neutral badge-xs">All</span>
                                Core Agents
                                <span class="text-xs font-normal text-base-content/50 ml-auto">({{ enrichedAgents|length }})</span>
                            </h4>
                            <div class="space-y-2">
                                {% for agent in enrichedAgents %}
                                <div class="item-card flex items-center justify-between gap-3 p-3 bg-base-200/50 border border-base-300 rounded-lg hover:border-primary/30 hover:bg-base-200 transition-all cursor-pointer group" data-name="{{ agent.name|lower }}" data-description="{{ (agent.description or '')|lower }}" onclick="showItemDetails('agent', '{{ agent.name }}')">
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <h5 class="font-semibold text-sm text-base-content">{{ agent.name }}</h5>
                                            {% if agent.type %}<span class="badge badge-primary badge-xs">{{ agent.type }}</span>{% endif %}
                                            {% if agent.version %}<span class="badge badge-ghost badge-xs">v{{ agent.version }}</span>{% endif %}
                                        </div>
                                        {% if agent.description %}
                                        <p class="text-xs text-base-content/60 line-clamp-1">{{ agent.description }}</p>
                                        {% endif %}
                                        {% if agent.tags and agent.tags|length > 0 %}
                                        <div class="flex items-center gap-1 flex-wrap mt-1">
                                            {% for tag in agent.tags %}
                                            <span class="badge badge-outline badge-xs">{{ tag }}</span>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    <button type="button" class="btn btn-xs btn-ghost btn-circle opacity-0 group-hover:opacity-100 transition-opacity shrink-0" onclick="event.stopPropagation(); showItemDetails('agent', '{{ agent.name }}')" aria-label="View {{ agent.name }} details">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    {% elif couchcmsAgents and couchcmsAgents|length > 0 %}
                        <!-- Fallback to simple list -->
                        <div class="space-y-2">
                            {% for agent in couchcmsAgents %}
                            <div class="item-card flex items-center justify-between gap-3 p-3 bg-base-200/50 border border-base-300 rounded-lg hover:border-primary/30 hover:bg-base-200 transition-all cursor-pointer" data-name="{{ agent|lower }}" onclick="showItemDetails('agent', '{{ agent }}')">
                                <span class="font-semibold text-sm text-base-content">{{ agent }}</span>
                                <button type="button" class="btn btn-xs btn-ghost btn-circle shrink-0" onclick="event.stopPropagation(); showItemDetails('agent', '{{ agent }}')" aria-label="View {{ agent }} details">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-sm text-base-content/60 italic text-center py-8">No agents found</p>
                    {% endif %}
                </div>
                </div>
            </div>
            <!-- Backdrop - click to close -->
            <form method="dialog" class="modal-backdrop">
                <button aria-label="Close modal">close</button>
            </form>
        </dialog>

        <!-- Item Detail Modal -->
        <dialog id="item-detail-modal" class="modal modal-middle">
            <div class="modal-box w-11/12 max-w-3xl max-h-[90vh] overflow-y-auto">
                <form method="dialog" class="absolute right-4 top-4 z-10">
                    <button class="btn btn-sm btn-circle btn-ghost text-base-content/60 hover:text-base-content hover:bg-base-200" aria-label="Close modal">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </form>

                <!-- Content will be loaded dynamically -->
                <div id="item-detail-content">
                    <div class="loading loading-spinner loading-lg"></div>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button aria-label="Close modal">close</button>
            </form>
        </dialog>

        <script>
            // Tab switching
            function switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('[data-tab]').forEach(btn => {
                    btn.classList.remove('tab-active')
                    btn.setAttribute('aria-selected', 'false')
                })
                const activeBtn = document.querySelector(`[data-tab="${tabName}"]`)
                if (activeBtn) {
                    activeBtn.classList.add('tab-active')
                    activeBtn.setAttribute('aria-selected', 'true')
                }

                // Update tab content
                document.getElementById('modules-tab-content').classList.toggle('hidden', tabName !== 'modules')
                document.getElementById('agents-tab-content').classList.toggle('hidden', tabName !== 'agents')

                // Clear search when switching tabs
                const searchInput = document.getElementById('module-agent-search')
                if (searchInput) {
                    searchInput.value = ''
                    filterItems('')
                }
            }

            // Filter items based on search query
            function filterItems(query) {
                const activeTab = document.querySelector('[data-tab].tab-active')?.getAttribute('data-tab') || 'modules'
                const contentId = activeTab === 'modules' ? 'modules-tab-content' : 'agents-tab-content'
                const container = document.getElementById(contentId)

                if (!container) return

                const searchTerm = query.toLowerCase().trim()
                const items = container.querySelectorAll('.item-card')

                if (!searchTerm) {
                    // Show all items
                    items.forEach(item => {
                        item.style.display = ''
                    })
                    return
                }

                // Filter items
                items.forEach(item => {
                    const name = item.getAttribute('data-name') || ''
                    const description = item.getAttribute('data-description') || ''
                    const matches = name.includes(searchTerm) || description.includes(searchTerm)
                    item.style.display = matches ? '' : 'none'
                })
            }

            // Show item details with API call
            function showItemDetails(type, name) {
                const modal = document.getElementById('item-detail-modal')
                const content = document.getElementById('item-detail-content')

                // Show loading state
                content.innerHTML = `
                    <div class="flex flex-col items-center justify-center min-h-[200px]">
                        <span class="loading loading-spinner loading-lg mb-4"></span>
                        <p class="text-sm text-base-content/60">Loading ${name} details...</p>
                    </div>
                `

                modal.showModal()

                // Fetch full details from API endpoint
                fetch(`/api/setup/${type}/${encodeURIComponent(name)}`)
                    .then(res => {
                        if (!res.ok) {
                            throw new Error(`Failed to load ${type}: ${res.statusText}`)
                        }
                        return res.json()
                    })
                    .then(data => {
                        renderItemDetails(content, data, type)
                    })
                    .catch(error => {
                        console.error(`Error loading ${type} details:`, error)
                        content.innerHTML = `
                            <div class="alert alert-error">
                                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                                <span>Failed to load details: ${error.message}</span>
                            </div>
                        `
                    })
            }

            // Render item details
            function renderItemDetails(container, data, type) {
                const isModule = type === 'module'
                const categoryBadge = getCategoryBadge(data.category || 'other', isModule)
                const requiredBadge = data.required ? '<span class="badge badge-error badge-sm">Required</span>' : ''
                const versionBadge = data.version ? `<span class="badge badge-ghost badge-sm">v${data.version}</span>` : ''
                const typeBadge = data.type ? `<span class="badge badge-primary badge-sm">${data.type}</span>` : ''

                // Build dependencies HTML
                let dependenciesHTML = ''
                if (data.requires && data.requires.length > 0) {
                    dependenciesHTML = `
                        <div class="mb-4">
                            <h5 class="font-semibold text-sm mb-2 text-base-content">Dependencies</h5>
                            <div class="flex flex-wrap gap-2">
                                ${data.requires.map(req => `<span class="badge badge-outline badge-sm">${req}</span>`).join('')}
                            </div>
                        </div>
                    `
                }

                // Build conflicts HTML
                let conflictsHTML = ''
                if (data.conflicts && data.conflicts.length > 0) {
                    conflictsHTML = `
                        <div class="mb-4">
                            <h5 class="font-semibold text-sm mb-2 text-base-content text-error">Conflicts</h5>
                            <div class="flex flex-wrap gap-2">
                                ${data.conflicts.map(conf => `<span class="badge badge-error badge-outline badge-sm">${conf}</span>`).join('')}
                            </div>
                        </div>
                    `
                }

                // Build tags HTML (for agents)
                let tagsHTML = ''
                if (data.tags && data.tags.length > 0) {
                    tagsHTML = `
                        <div class="mb-4">
                            <h5 class="font-semibold text-sm mb-2 text-base-content">Tags</h5>
                            <div class="flex flex-wrap gap-2">
                                ${data.tags.map(tag => `<span class="badge badge-outline badge-sm">${tag}</span>`).join('')}
                            </div>
                        </div>
                    `
                }

                // Build content preview
                let contentHTML = ''
                if (data.content && data.content.trim()) {
                    // Simple markdown-like formatting
                    const formattedContent = data.content
                        .replace(/^#+\s+(.+)$/gm, '<h4 class="font-semibold text-base mt-4 mb-2">$1</h4>')
                        .replace(/```[\s\S]*?```/g, '<pre class="bg-base-200 p-2 rounded text-xs overflow-x-auto"><code>$&</code></pre>')
                        .replace(/`([^`]+)`/g, '<code class="bg-base-200 px-1 rounded text-xs">$1</code>')
                        .replace(/\n\n/g, '</p><p class="text-sm text-base-content/70 mb-2">')

                    contentHTML = `
                        <div class="mb-4">
                            <h5 class="font-semibold text-sm mb-2 text-base-content">Overview</h5>
                            <div class="prose prose-sm max-w-none">
                                <p class="text-sm text-base-content/70 mb-2">${formattedContent}</p>
                            </div>
                        </div>
                    `
                }

                container.innerHTML = `
                    <div class="mb-6 pr-10">
                        <div class="flex items-center gap-2 mb-3">
                            <h3 class="font-bold text-2xl text-base-content">${data.name || 'Unknown'}</h3>
                            ${categoryBadge}
                            ${requiredBadge}
                            ${versionBadge}
                            ${typeBadge}
                        </div>
                        ${data.description ? `<p class="text-base text-base-content/70 leading-relaxed mb-4">${data.description}</p>` : ''}
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                        <div class="stat bg-base-200 rounded-lg p-4">
                            <div class="stat-title text-xs">Category</div>
                            <div class="stat-value text-lg">${(data.category || 'other').charAt(0).toUpperCase() + (data.category || 'other').slice(1)}</div>
                        </div>
                        <div class="stat bg-base-200 rounded-lg p-4">
                            <div class="stat-title text-xs">Version</div>
                            <div class="stat-value text-lg">${data.version || 'N/A'}</div>
                        </div>
                    </div>

                    ${dependenciesHTML}
                    ${conflictsHTML}
                    ${tagsHTML}
                    ${contentHTML}
                `
            }

            // Get category badge HTML
            function getCategoryBadge(category, isModule) {
                const badges = {
                    core: '<span class="badge badge-error badge-sm">Core</span>',
                    navigation: '<span class="badge badge-info badge-sm">Navigation</span>',
                    content: '<span class="badge badge-success badge-sm">Content</span>',
                    frontend: '<span class="badge badge-secondary badge-sm">Frontend</span>',
                    'dev-tools': '<span class="badge badge-info badge-sm">Dev Tools</span>',
                    other: '<span class="badge badge-neutral badge-sm">Other</span>'
                }

                if (isModule) {
                    return badges[category] || badges.other
                } else {
                    // For agents
                    if (category === 'core') return badges.core
                    if (category === 'frontend') return badges.frontend
                    if (category === 'dev-tools') return badges['dev-tools']
                    return badges.other
                }
            }
        </script>
    </div>

    <form hx-post="/api/setup/generate" hx-target="#wizard-content" hx-swap="innerHTML" class="mt-6" id="generate-form">
        <input type="hidden" name="setupType" value="{{ setupType }}" />
        <input type="hidden" name="projectName" value="{{ projectName }}" />
        <input type="hidden" name="projectDescription" value="{{ projectDescription }}" />

        {% if setupType == 'extended' %}
        {% for css in frontend.css %}
        <input type="hidden" name="css" value="{{ css }}" />
        {% endfor %}
        {% for js in frontend.js %}
        <input type="hidden" name="js" value="{{ js }}" />
        {% endfor %}
        {% if framework %}
        <input type="hidden" name="framework" value="true" />
        {% if framework.doctrine %}<input type="hidden" name="framework_doctrine" value="true" />{% endif %}
        {% if framework.directives %}<input type="hidden" name="framework_directives" value="true" />{% endif %}
        {% if framework.playbooks %}<input type="hidden" name="framework_playbooks" value="true" />{% endif %}
        {% if framework.enhancements %}<input type="hidden" name="framework_enhancements" value="true" />{% endif %}
        {% endif %}
        <input type="hidden" name="contextDir" value="config/context" />
        {% else %}
        {# Simple setup: explicitly pass empty arrays to ensure no frontend frameworks are included #}
        <input type="hidden" name="css" value="" />
        <input type="hidden" name="js" value="" />
        <input type="hidden" name="framework" value="false" />
        <input type="hidden" name="contextDir" value=".project" />
        {% endif %}

        {% for editor in editors %}
        <input type="hidden" name="editors" value="{{ editor }}" />
        {% endfor %}

        {% if preset and preset != '' %}
        <input type="hidden" name="preset" value="{{ preset }}" />
        {% endif %}

        {# Hidden field to store complete state from sessionStorage as JSON #}
        <input type="hidden" name="wizardState" id="wizard-state-input" value="" />

        <div class="flex flex-col sm:flex-row justify-between gap-3 sm:gap-0 mt-4 sm:mt-6">
            <button type="button" id="review-back-button" onclick="if (window.wizardNavigation) { window.wizardNavigation.navigateBack(); } else if (typeof goBack === 'function') { goBack(); } return false;" class="relative inline-flex items-center justify-center h-auto px-4 sm:px-6 py-3 sm:py-3 text-xs sm:text-sm font-medium transition-colors bg-base-100 rounded-full border border-base-300 hover:bg-base-200 active:bg-base-200 focus:outline-none gap-2 cursor-pointer min-h-[44px] sm:min-h-0" aria-label="Go back to previous step">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 sm:h-5 sm:w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                </svg>
                Back
            </button>
            <button type="submit" class="relative inline-flex items-center justify-center h-auto px-4 sm:px-6 py-3 sm:py-3 text-xs sm:text-sm font-medium text-primary-content transition-colors bg-primary rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary hover:bg-primary/90 active:bg-primary/80 gap-2 cursor-pointer min-h-[44px] sm:min-h-0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                Generate Configuration
            </button>
        </div>
    </form>
</div>

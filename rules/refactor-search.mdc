---
description: Auto-load refactoring rules for CouchCMS search
globs: ['{{paths.snippets}}/**/*search*.html', '*.php']
alwaysApply: false
---

# Refactoring Rules for CouchCMS Search

## ğŸš¨ CRITICAL: Refactoring Workflow

**When a refactoring request is made (e.g., "refactor @file.html" for search), you MUST:**

1. **First**: Load and follow `@ai-toolkit-shared/prompts/refactoring/router.md`
2. **Router will**: Analyze the file, select appropriate specialist(s), request confirmation
3. **Then**: Apply the rules below as part of the selected specialist workflow

**Never skip the router analysis step - it ensures the correct specialist is selected.**

---

When refactoring this file, apply these rules:

## Search Variables

- âœ… Always use `k_search_title` (not `k_page_title`) for highlighted results
- âœ… Always use `k_search_excerpt` (not regular content) for result snippets
- âœ… Use `k_search_keywords` to show search terms
- âœ… Use `k_total_records` for result count
- âŒ Never use `k_page_title` in search results (no highlighting)

## Search Form

- âœ… Use `<cms:search_form>` for quick implementation
- âœ… Use custom form with `name="s"` for input field
- âœ… Set `processor` parameter to point to search results page
- âœ… Preserve search terms: `value="<cms:gpc 's' />"`
- âœ… Place search forms in navigation or dedicated search page

## Search Implementation

- âœ… Use `<cms:search>` tag for search results
- âœ… Set `masterpage` to limit search scope
- âœ… Use `keywords` parameter when passing terms programmatically
- âœ… Implement pagination for large result sets
- âœ… Handle empty results gracefully

## Search Scope

- âœ… Limit search to specific templates: `masterpage='blog.php'`
- âœ… Search multiple templates: `masterpage='blog.php,news.php'`
- âœ… Exclude templates: `masterpage='!admin.php,!drafts.php'`
- âœ… Filter by folder: `folder='news'`
- âœ… Use appropriate scope for site size

## Pagination

- âœ… Use `paginate='1'` for large result sets
- âœ… Display pagination info with `k_paginated_top` and `k_paginated_bottom`
- âœ… Show record counts: `k_record_from`, `k_record_to`, `k_total_records`
- âœ… Use `<cms:paginator />` for navigation
- âœ… Check `k_paginator_required` before showing pagination info

## Result Display

- âœ… Show highlighted search terms in results
- âœ… Display result count and current page info
- âœ… Use cards or list format for results
- âœ… Include link to full page
- âœ… Show excerpt with highlighted terms

## Empty Results

- âœ… Check `k_total_records='0'` for empty results
- âœ… Display helpful message when no results found
- âœ… Show search terms in empty state message
- âœ… Suggest alternative search terms or actions
- âœ… Provide clear feedback to user

## Fulltext Limitations

- âœ… Inform users that words < 4 characters are ignored
- âœ… Handle short word searches gracefully
- âœ… Consider custom search logic for short words if needed
- âœ… Document limitations in UI if necessary

## Performance

- âœ… Limit search scope to necessary templates
- âœ… Use pagination to reduce result set size
- âœ… Consider caching for popular searches
- âœ… Optimize for large sites with template/folder filtering

## Advanced Features

- âœ… Use date range filtering when needed
- âœ… Filter by category/folder in results
- âœ… Show template name in multi-template search
- âœ… Implement autocomplete for search form
- âœ… Use Alpine.js for enhanced search UX

## Checklist

- [ ] Using `k_search_title` and `k_search_excerpt` (not `k_page_title`)
- [ ] Search form properly configured
- [ ] Search scope appropriately limited
- [ ] Pagination implemented for large result sets
- [ ] Empty results handled gracefully
- [ ] Result count and page info displayed
- [ ] Highlighted search terms visible
- [ ] Performance optimizations applied
- [ ] Fulltext limitations considered
- [ ] User feedback clear and helpful
- [ ] Search form accessible and user-friendly

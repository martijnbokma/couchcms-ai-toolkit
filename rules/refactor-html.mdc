---
description: Auto-load refactoring rules for HTML/CouchCMS templates
globs: ['{{paths.snippets}}/**/*.html', '*.php']
alwaysApply: false
---

# Refactoring Rules for CouchCMS Templates

## ğŸš¨ CRITICAL: Refactoring Workflow

**When a refactoring request is made (e.g., "refactor @file.php" or "refactor @file.html"), you MUST:**

1. **First**: Load and follow `@ai-toolkit-shared/prompts/refactoring/router.md`
2. **Router will**: Analyze the file, select appropriate specialist(s), request confirmation
3. **Then**: Apply the rules below as part of the selected specialist workflow

**Never skip the router analysis step - it ensures the correct specialist is selected.**

---

When refactoring this file, apply these rules:

## CouchCMS Safety

- âŒ Never use `<cms:` in HTML comments (will execute and crash)
- âœ… Use `[cms:` syntax in comments instead
- âœ… Check layout files too for shorthand syntax issues

## Alpine.js Compatibility

- âŒ Never use `@click` shorthand in CouchCMS templates
- âŒ Never use `:class` shorthand in CouchCMS templates
- âœ… Always use `x-on:click` full syntax
- âœ… Always use `x-bind:class` full syntax

## Code Quality

- Extract repeated patterns into reusable snippets
- Use `<cms:embed>` for shared components
- Use authentication filters: `<cms:embed '{{paths.filters}}/authenticated.html' />`
- Use ownership filters for edit/delete operations
- Keep Alpine.js components < 50 lines (move complex logic to TypeScript)

## Styling

- Use daisyUI semantic colors: `bg-base-100`, `text-base-content`
- Avoid Tailwind color names: `bg-gray-100`, `text-black`
- Mobile-first responsive: `sm:`, `md:`, `lg:` prefixes

## Custom Routes

- âœ… Use `K_IGNORE_CONTEXT` in `COUCH::invoke()` for custom routes
- âœ… Define routes in template block: `<cms:route name='list' pattern='projects' />`
- âœ… Use route variables: `k_route_name`, `k_route_param_*`
- âœ… Add route constraints for validation: `constraints="id=\d+"`
- âœ… Implement authentication filters for protected routes
- âŒ Never forget `K_IGNORE_CONTEXT` (causes 404 on all routes)

## Pagination

- âœ… Use `paginate='1'` for large result sets
- âœ… Display pagination info with `k_paginated_top` and `k_paginated_bottom`
- âœ… Check `k_paginator_required` before showing pagination info
- âœ… Show record counts: `k_record_from`, `k_record_to`, `k_total_records`
- âœ… Use `<cms:paginator />` for navigation links
- âœ… Handle edge cases (no results, single page)

## Relationships

- âœ… Define relationship in one template only (primary template)
- âœ… Use descriptive relationship names (e.g., `artist_albums`)
- âœ… Use `related_pages` in primary template context
- âœ… Use `reverse_related_pages` with `masterpage` parameter
- âœ… Always specify `masterpage` in `reverse_related_pages`
- âœ… Use relationship parameters for filtering and ordering
- âŒ Never define relationship in both templates (causes conflicts)

## Repeatable Regions

- âœ… Wrap editable regions in `<cms:repeatable>` tag
- âœ… Use `show_repeatable` to display values (not `show`)
- âœ… Use `col_width` for admin panel layout control
- âœ… Use `nicedit` instead of `richtext` in repeatable regions
- âœ… Check for empty repeatable regions before displaying
- âœ… Use `k_count` and `k_total_records` for item numbering
- âŒ Never use `richtext` in repeatable (use `nicedit`)

## Template Structure

- âœ… Use proper template inheritance: `<cms:extends>` immediately after `require_once`
- âœ… Define templates in `<cms:block 'templates'>`
- âœ… Use `<cms:block 'content'>` for page content
- âœ… Always include `content_owner` and `is_published` system fields
- âœ… Use `<cms:embed>` for reusable components
- âœ… Place views in `{{paths.views}}/`, components in `{{paths.components}}/`

## Caching & Performance

- âœ… Use `<cms:cached>` for expensive queries
- âœ… Invalidate cache on form submit: `_invalidate_cache="1"`
- âœ… Use reasonable pagination limits (10-20 items)
- âœ… Use `limit` and `orderby` for large relationship sets

## JSON API

- âœ… Set content type: `<cms:content_type 'application/json' />`
- âœ… Use `<cms:escape_json>` for JSON output
- âœ… Handle pagination in JSON: `<cms:if "<cms:not k_paginated_bottom />">,</cms:if>`

## Checklist

- [ ] No `<cms:` in HTML comments (use `[cms:`)
- [ ] No `@` or `:` Alpine shorthand (use `x-on:`, `x-bind:`)
- [ ] ARIA attributes for accessibility
- [ ] DaisyUI semantic colors
- [ ] Reusable snippets (DRY)
- [ ] 4-space indentation
- [ ] English-only code/comments
- [ ] Custom routes use `K_IGNORE_CONTEXT`
- [ ] Pagination enabled for large result sets
- [ ] Relationships defined in one template only
- [ ] Repeatable regions use `show_repeatable` (not `show`)
- [ ] Template structure follows inheritance pattern
- [ ] Authentication filters on protected routes
- [ ] Ownership validation on edit/delete operations



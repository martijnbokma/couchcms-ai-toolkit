---
description: Auto-load refactoring rules for CouchCMS user management
globs: ['{{paths.snippets}}/**/*user*.html', '{{paths.filters}}/**/*.html', '*.php']
alwaysApply: false
---

# Refactoring Rules for CouchCMS User Management

## ðŸš¨ CRITICAL: Refactoring Workflow

**When a refactoring request is made (e.g., "refactor @file.html" for user management), you MUST:**

1. **First**: Load and follow `@ai-toolkit-shared/prompts/refactoring/router.md`
2. **Router will**: Analyze the file, select appropriate specialist(s), request confirmation
3. **Then**: Apply the rules below as part of the selected specialist workflow

**Never skip the router analysis step - it ensures the correct specialist is selected.**

---

When refactoring this file, apply these rules:

## Authentication Checks

- âœ… Use `k_logged_in` / `k_logged_out` for authentication
- âœ… Use `k_user_access_level` for authorization (not just `k_logged_in`)
- âœ… Check access level with `ge` (greater or equal): `k_user_access_level ge '2'`
- âœ… Provide login links when access denied
- âŒ Never trust client-side checks alone

## Access Level Hierarchy

- âœ… Super Admin: `k_user_access_level ge '10'`
- âœ… Administrator: `k_user_access_level ge '7'`
- âœ… Authenticated User (Special): `k_user_access_level ge '4'`
- âœ… Authenticated User: `k_user_access_level ge '2'`
- âœ… Unauthenticated: `k_user_access_level eq '0'`
- âœ… Remember hierarchy: 10 > 7 > 4 > 2 > 0

## Template-Level Access

- âœ… Set `access_level` in template tag for template-wide protection
- âœ… Use `access_level='2'` for authenticated users only
- âœ… Use `access_level='7'` for administrators only
- âœ… Combine with element-level checks for fine-grained control

## Element-Level Access

- âœ… Use `cms:if k_user_access_level ge 'X'` for element protection
- âœ… Provide clear feedback when access denied
- âœ… Show login link for unauthenticated users
- âœ… Explain required access level
- âœ… Handle different access levels gracefully

## User Variables

- âœ… Use `k_user_id` for user identification
- âœ… Use `k_user_name` for username
- âœ… Use `k_user_title` for display name
- âœ… Use `k_user_email` for email address
- âœ… Use `k_user_access_level` for permission checks

## Login/Logout Links

- âœ… Use `k_login_link` for login page
- âœ… Use `k_logout_link` for logout
- âœ… Always provide login link when access denied
- âœ… Show logout link when user is logged in
- âœ… Use in navigation for user convenience

## User Profile Display

- âœ… Show user information when logged in
- âœ… Display user avatar/initial
- âœ… Show access level/role clearly
- âœ… Provide logout option
- âœ… Use appropriate styling for user info

## Protected Content

- âœ… Check access level before showing content
- âœ… Provide clear message when access denied
- âœ… Explain required access level
- âœ… Offer login option for unauthenticated users
- âœ… Handle edge cases (disabled users, etc.)

## Conditional Navigation

- âœ… Show different navigation based on access level
- âœ… Show admin links only to administrators
- âœ… Show user-specific links when logged in
- âœ… Hide protected links from unauthorized users
- âœ… Use access level checks in navigation

## Form Access Control

- âœ… Check access level before showing forms
- âœ… Allow create for level 2+ users
- âœ… Allow edit/delete for level 7+ users
- âœ… Show appropriate form fields based on access
- âœ… Validate access on form submission

## File Downloads

- âœ… Use `cloak_url` for protected file downloads
- âœ… Check access level before showing download link
- âœ… Provide login prompt for unauthorized users
- âœ… Handle download access gracefully

## User-Specific Content

- âœ… Filter content by `k_user_name` for user-specific pages
- âœ… Use `folder=k_user_name` for user folders
- âœ… Show only user's own content
- âœ… Provide ownership validation

## Security Best Practices

- âœ… Always verify access server-side
- âœ… Never trust client-side checks alone
- âœ… Use access level checks, not just login status
- âœ… Provide clear feedback for denied access
- âœ… Handle security edge cases

## Checklist

- [ ] Access level checked (not just `k_logged_in`)
- [ ] Template-level access set when needed
- [ ] Element-level access implemented
- [ ] Login/logout links provided
- [ ] User profile displayed correctly
- [ ] Protected content properly secured
- [ ] Navigation conditional on access level
- [ ] Forms check access before display
- [ ] File downloads protected
- [ ] User-specific content filtered
- [ ] Security measures applied
- [ ] Clear feedback for denied access
- [ ] Edge cases handled

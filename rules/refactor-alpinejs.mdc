---
description: Auto-load refactoring rules for Alpine.js components
globs: ['{{paths.snippets}}/**/*.html', '*.php', '{{paths.javascript}}/**/*.js']
alwaysApply: false
---

# Refactoring Rules for Alpine.js

## ğŸš¨ CRITICAL: Refactoring Workflow

**When a refactoring request is made (e.g., "refactor @file.html" with Alpine.js), you MUST:**

1. **First**: Load and follow `@ai-toolkit-shared/prompts/refactoring/router.md`
2. **Router will**: Analyze the file, select appropriate specialist(s), request confirmation
3. **Then**: Apply the rules below as part of the selected specialist workflow

**Never skip the router analysis step - it ensures the correct specialist is selected.**

---

When refactoring this file, apply these rules:

## CouchCMS Syntax Requirements

- âŒ Never use `@click` shorthand in CouchCMS templates (colon conflicts)
- âŒ Never use `:class` shorthand in CouchCMS templates
- âœ… Always use `x-on:click` full syntax
- âœ… Always use `x-bind:class` full syntax
- âœ… Check layout files too for shorthand syntax issues

## Component Complexity

- âŒ Never put complex logic in `x-data` (> 50 lines)
- âœ… Keep Alpine components simple and focused
- âœ… Move complex logic to TypeScript modules
- âœ… Export functions for Alpine use on `window`
- âœ… Use `alpine:init` event for initialization

## State Management

- âŒ Never mutate objects/arrays directly (breaks reactivity)
- âœ… Use spread operator: `items = [...items, newItem]`
- âœ… Use immutable patterns for state updates
- âœ… Use Alpine stores for global state
- âœ… Use `$persist` for localStorage persistence

## Performance

- âœ… Use `x-show` for simple visibility (always renders, just hides)
- âœ… Use `x-if` for conditional rendering (only renders when true)
- âœ… Use `x-cloak` to prevent flash of unstyled content
- âœ… Debounce expensive operations (search, API calls)
- âœ… Use `x-intersect` for lazy loading

## Accessibility

- âœ… Add ARIA attributes: `aria-expanded`, `aria-controls`, `role`
- âœ… Use semantic HTML elements
- âœ… Ensure keyboard navigation works
- âœ… Add focus management for modals/dropdowns
- âœ… Use `x-on:keydown.escape` for closing modals

## TypeScript Integration

- âœ… Define interfaces for Alpine component data
- âœ… Export typed functions for Alpine use
- âœ… Register functions globally: `window.functionName = functionName`
- âœ… Use type guards for runtime validation
- âœ… Keep TypeScript logic separate from Alpine templates

## Reusable Components

- âœ… Extract repeated Alpine patterns into reusable components
- âœ… Use `Alpine.data()` for component definitions
- âœ… Pass configuration as parameters
- âœ… Use Alpine stores for shared state
- âœ… Create component snippets in `{{paths.components}}/`

## Event Handling

- âœ… Use `x-on:` for all event handlers in CouchCMS
- âœ… Use modifiers: `.prevent`, `.stop`, `.debounce`, `.once`
- âœ… Use `x-on:click.outside` for dropdowns
- âœ… Use `x-on:keydown.escape.window` for global shortcuts
- âœ… Clean up event listeners (Alpine handles this automatically)

## Form Integration

- âœ… Use `x-model` for two-way binding
- âœ… Use `x-on:input` for real-time validation
- âœ… Show validation errors with `x-show` or `x-if`
- âœ… Disable submit button during submission
- âœ… Use `x-bind:disabled` for button states

## Modal Patterns

- âœ… Use `x-show` with `x-bind:class` for modal state
- âœ… Add `x-on:keydown.escape.window` for ESC key
- âœ… Use `x-on:click.outside` for backdrop click
- âœ… Manage focus trap for accessibility
- âœ… Use `x-cloak` to prevent flash

## Dropdown Patterns

- âœ… Use `x-show` for dropdown visibility
- âœ… Use `x-on:click.outside` to close on outside click
- âœ… Add `aria-expanded` and `aria-controls`
- âœ… Use `role="menu"` and `role="menuitem"`
- âœ… Handle keyboard navigation

## Checklist

- [ ] No `@` or `:` shorthand in CouchCMS templates
- [ ] Components follow single responsibility (< 50 lines)
- [ ] Complex logic moved to TypeScript
- [ ] ARIA attributes present for accessibility
- [ ] Events properly debounced/throttled
- [ ] State updates use immutable patterns
- [ ] `x-cloak` used to prevent flash
- [ ] Layout files checked for shorthand syntax
- [ ] TypeScript integration via window exports
- [ ] Reusable components extracted
- [ ] Performance optimizations applied
- [ ] Keyboard navigation works
- [ ] Focus management implemented

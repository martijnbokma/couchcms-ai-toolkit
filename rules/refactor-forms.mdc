---
description: Auto-load refactoring rules for DataBound Forms
globs: ['{{paths.forms}}/**/*.html', '{{paths.views}}/**/create*.html', '{{paths.views}}/**/edit*.html']
alwaysApply: false
---

# Refactoring Rules for DataBound Forms

## ğŸš¨ CRITICAL: Refactoring Workflow

**When a refactoring request is made (e.g., "refactor @file.html" for forms), you MUST:**

1. **First**: Load and follow `@ai-toolkit-shared/prompts/refactoring/router.md`
2. **Router will**: Analyze the file, select appropriate specialist(s), request confirmation
3. **Then**: Apply the rules below as part of the selected specialist workflow

**Never skip the router analysis step - it ensures the correct specialist is selected.**

---

When refactoring this file, apply these rules:

## Form Structure

- âœ… Use `enctype='multipart/form-data'` for file uploads
- âœ… Set `masterpage` and `mode` attributes
- âœ… Handle `k_success` and `k_error` properly

## Validation Placement

- âŒ Never validate on bound inputs
- âœ… Define validation on editable regions in template
- âœ… Bound inputs just bind, validation is inherited

## Security

- âœ… Use `<cms:embed '{{paths.filters}}/authenticated.html' />`
- âœ… Use ownership filters for edit/delete
- âœ… Set `content_owner=k_user_name` on create
- âœ… Add anti-spam for public forms

## Error Handling

- âœ… Display `k_error` with proper styling
- âœ… Show field-specific errors: `k_error_fieldname`
- âœ… Use flash messages for success feedback
- âœ… Add loading states during submission

## DRY Principle

- âœ… Extract form fields into reusable snippets
- âœ… Share between create and edit views
- âœ… Use `<cms:embed>` for form partials

## Checklist

- [ ] `enctype` for file uploads
- [ ] Validation on editable regions (not inputs)
- [ ] Authentication filter present
- [ ] Ownership check on edit/delete
- [ ] Setting `content_owner` on create
- [ ] Error display with `k_error`
- [ ] Success feedback with flash
- [ ] Reusable form snippets


